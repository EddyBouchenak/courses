<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mes Courses</title>
    <meta name="description" content="Liste de courses compl√®te avec tri par rayon.">
    <style>
        /* --- 1. Variables & Th√®mes --- */
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #388E3C;
            --bg-color: #f9f9f9;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --danger-color: #ff5252;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --radius: 16px;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-secondary: #aaaaaa;
            --border-color: #333333;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        /* --- 2. Reset & Base --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 100px;
            transition: background-color 0.3s, color 0.3s;
            touch-action: manipulation;
        }

        *:not(input) {
            user-select: none;
        }

        /* --- 3. Header --- */
        .app-header {
            background-color: var(--card-bg);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary-color);
            letter-spacing: -0.5px;
        }

        #theme-toggle {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
        }

        /* --- 4. Recherche --- */
        .search-container {
            position: relative;
        }

        #search-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid transparent;
            background-color: var(--bg-color);
            border-radius: var(--radius);
            font-size: 1rem;
            color: var(--text-color);
            transition: all 0.2s;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            user-select: text;
        }

        #search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--card-bg);
        }

        .autocomplete-items {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-height: 250px;
            overflow-y: auto;
            z-index: 99;
            border: 1px solid var(--border-color);
        }

        .autocomplete-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: var(--bg-color);
        }

        .hidden {
            display: none;
        }

        /* --- 5. Contenu Principal --- */
        .app-content {
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0 0.5rem 0;
        }

        h2 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        /* En-t√™te de rayon */
        .list-group-header {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--primary-dark);
            text-transform: uppercase;
            background-color: rgba(76, 175, 80, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 16px;
            margin-bottom: 6px;
            display: inline-block;
        }

        [data-theme="dark"] .list-group-header {
            background-color: rgba(76, 175, 80, 0.2);
            color: #81c784;
        }

        /* --- 6. Liste des Articles --- */
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
            padding: 10px 12px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        .shopping-item:active {
            transform: scale(0.98);
        }

        .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .shopping-item.bought .checkbox {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .shopping-item.bought .checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .item-info {
            flex-grow: 1;
            min-width: 0;
        }

        .item-name {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-details {
            display: flex;
            gap: 6px;
            margin-top: 2px;
        }

        .qty-badge {
            font-size: 0.7rem;
            background-color: var(--primary-color);
            color: white;
            padding: 1px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .shopping-item.bought {
            opacity: 0.6;
        }

        .shopping-item.bought .item-name {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .shopping-item.bought .qty-badge {
            background-color: var(--text-secondary);
        }

        /* Contr√¥les de Quantit√© */
        .qty-control {
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2px;
            margin-left: 8px;
            height: 36px;
        }

        .shopping-item.bought .qty-control {
            display: none;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: transparent;
            color: var(--primary-color);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .qty-btn:active {
            background-color: rgba(0, 0, 0, 0.1);
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .qty-input {
            width: 45px;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-color);
            padding: 0;
            user-select: text;
        }

        .qty-input:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .unit-btn {
            font-size: 0.65rem;
            background-color: var(--border-color);
            color: var(--text-secondary);
            border: none;
            border-radius: 8px;
            padding: 4px 6px;
            margin: 0 4px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 800;
            min-width: 28px;
            flex-shrink: 0;
        }

        /* --- 7. Catalogue --- */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 10px;
        }

        .category-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
        }

        .category-card:hover {
            border-color: var(--primary-color);
        }

        .cat-icon {
            font-size: 1.8rem;
            display: block;
            margin-bottom: 5px;
        }

        .cat-name {
            font-size: 0.8rem;
            font-weight: 600;
            display: block;
            line-height: 1.2;
        }

        /* --- 8. Footer --- */
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            padding: 1rem;
            text-align: center;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 90;
        }

        .danger-btn {
            background: none;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .text-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .primary-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .primary-btn:active {
            transform: scale(0.96);
        }

        .hidden-visually {
            display: none !important;
        }

        .divider {
            border: 0;
            border-top: 1px solid var(--border-color);
            margin: 2rem 0;
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
            font-style: italic;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <header class="app-header">
        <div class="header-top">
            <h1>Mes Courses</h1>
            <button id="theme-toggle" aria-label="Changer le th√®me">üåô</button>
        </div>

        <div class="search-container">
            <input type="text" id="search-input" placeholder="üîç Ajouter (ex: Pommes)..." autocomplete="off"
                enterkeyhint="search">
            <div id="autocomplete-list" class="autocomplete-items hidden"></div>
        </div>
    </header>

    <main class="app-content">
        <section id="shopping-list-section">
            <div class="section-header">
                <h2>√Ä acheter <span id="count-to-buy">(0)</span></h2>
            </div>
            <div id="list-to-buy" class="item-list">
                <div class="empty-state">Ta liste est vide. Ajoute des articles !</div>
            </div>

            <div class="section-header" style="margin-top: 2.5rem;">
                <h2>D√©j√† achet√© <span id="count-bought">(0)</span></h2>
                <button id="toggle-bought-btn" class="text-btn">Masquer</button>
            </div>
            <div id="list-bought" class="item-list bought-list"></div>
        </section>

        <hr class="divider">

        <section id="catalog-section">
            <h2>Parcourir les rayons</h2>
            <div id="categories-grid" class="categories-grid"></div>
        </section>
    </main>

    <footer class="app-footer">
        <button id="share-btn" class="primary-btn">üì§ Partager</button>
        <button id="reset-btn" class="danger-btn">üóëÔ∏è Tout vider</button>
    </footer>

    <script>
        /**
         * Application Courses - Donn√©es compl√®tes et tri√©es
         */

        // --- 1. Donn√©es ---
        const categories = [
            { id: 'fruits', nom: 'Fruits & L√©gumes', icon: 'üçé' },
            { id: 'viandes', nom: 'Viandes & Poissons', icon: 'ü•©' },
            { id: 'frais', nom: 'Frais & Cr√®merie', icon: 'üßÄ' },
            { id: 'epicerie', nom: '√âpicerie', icon: 'üçù' },
            { id: 'boissons', nom: 'Boissons', icon: 'üßÉ' },
            { id: 'hygiene', nom: 'Hygi√®ne & Beaut√©', icon: 'üßº' },
            { id: 'entretien', nom: 'Maison', icon: 'üßπ' },
            { id: 'divers', nom: 'Divers', icon: 'üí°' }
        ];

        // Liste compl√®te et cat√©goris√©e
        const baseDefaultItems = [
            // Fruits & L√©gumes
            { id: 'abricots', nom: 'Abricots', cat: 'fruits' }, { id: 'agrumes', nom: 'Agrumes', cat: 'fruits' },
            { id: 'ail', nom: 'Ail', cat: 'fruits' }, { id: 'ananas', nom: 'Ananas', cat: 'fruits' },
            { id: 'artichauts', nom: 'Artichauts', cat: 'fruits' }, { id: 'aubergines', nom: 'Aubergines', cat: 'fruits' },
            { id: 'avocats', nom: 'Avocats', cat: 'fruits' }, { id: 'bananes', nom: 'Bananes', cat: 'fruits' },
            { id: 'brocolis', nom: 'Brocolis', cat: 'fruits' }, { id: 'brugnons', nom: 'Brugnons', cat: 'fruits' },
            { id: 'carambole', nom: 'Carambole', cat: 'fruits' }, { id: 'carottes', nom: 'Carottes', cat: 'fruits' },
            { id: 'cerises', nom: 'Cerises', cat: 'fruits' }, { id: 'champignons', nom: 'Champignons', cat: 'fruits' },
            { id: 'choux', nom: 'Choux', cat: 'fruits' }, { id: 'citrons', nom: 'Citrons', cat: 'fruits' },
            { id: 'concombres', nom: 'Concombres', cat: 'fruits' }, { id: 'courgettes', nom: 'Courgettes', cat: 'fruits' },
            { id: 'cresson', nom: 'Cresson', cat: 'fruits' }, { id: 'dattes', nom: 'Dattes', cat: 'fruits' },
            { id: 'endives', nom: 'Endives', cat: 'fruits' }, { id: 'epinards', nom: '√âpinards', cat: 'fruits' },
            { id: 'fenouil', nom: 'Fenouil', cat: 'fruits' }, { id: 'figues', nom: 'Figues', cat: 'fruits' },
            { id: 'fraises', nom: 'Fraises', cat: 'fruits' }, { id: 'framboises', nom: 'Framboises', cat: 'fruits' },
            { id: 'gingembre', nom: 'Gingembre', cat: 'fruits' }, { id: 'haricots', nom: 'Haricots', cat: 'fruits' },
            { id: 'herbe', nom: 'Herbe', cat: 'fruits' }, { id: 'kiwis', nom: 'Kiwis', cat: 'fruits' },
            { id: 'kumquats', nom: 'Kumquats', cat: 'fruits' }, { id: 'mandarines', nom: 'Mandarines', cat: 'fruits' },
            { id: 'mangues', nom: 'Mangues', cat: 'fruits' }, { id: 'marrons', nom: 'Marrons', cat: 'fruits' },
            { id: 'melon', nom: 'Melon', cat: 'fruits' }, { id: 'menthe', nom: 'Menthe', cat: 'fruits' },
            { id: 'myrtilles', nom: 'Myrtilles', cat: 'fruits' }, { id: 'navets', nom: 'Navets', cat: 'fruits' },
            { id: 'oignons', nom: 'Oignons', cat: 'fruits' }, { id: 'oranges', nom: 'Oranges', cat: 'fruits' },
            { id: 'oseille', nom: 'Oseille', cat: 'fruits' }, { id: 'pachino', nom: 'Pachino', cat: 'fruits' },
            { id: 'papaye', nom: 'Papaye', cat: 'fruits' }, { id: 'patate', nom: 'Patate', cat: 'fruits' },
            { id: 'poireaux', nom: 'Poireaux', cat: 'fruits' }, { id: 'poires', nom: 'Poires', cat: 'fruits' },
            { id: 'poivrons', nom: 'Poivrons', cat: 'fruits' }, { id: 'pommes', nom: 'Pommes', cat: 'fruits' },
            { id: 'prune', nom: 'Prune', cat: 'fruits' }, { id: 'radis', nom: 'Radis', cat: 'fruits' },
            { id: 'raisin', nom: 'Raisin', cat: 'fruits' }, { id: 'romarin', nom: 'Romarin', cat: 'fruits' },
            { id: 'salade', nom: 'Salade', cat: 'fruits' }, { id: 'tomates', nom: 'Tomates', cat: 'fruits' },
            { id: 'truffe', nom: 'Truffe', cat: 'fruits' },

            // Viandes & Poissons
            { id: 'abats', nom: 'Abats', cat: 'viandes' }, { id: 'anchois', nom: 'Anchois', cat: 'viandes' },
            { id: 'beaujolaise', nom: 'Beaujolaise', cat: 'viandes' }, { id: 'boeuf', nom: 'Boeuf', cat: 'viandes' },
            { id: 'brochettes', nom: 'Brochettes', cat: 'viandes' }, { id: 'canard', nom: 'Canard', cat: 'viandes' },
            { id: 'caviar', nom: 'Caviar', cat: 'viandes' }, { id: 'crabe', nom: 'Crabe', cat: 'viandes' },
            { id: 'crevettes', nom: 'Crevettes', cat: 'viandes' }, { id: 'deconfite', nom: 'D√©confite', cat: 'viandes' },
            { id: 'effiloche', nom: 'Effiloch√©', cat: 'viandes' }, { id: 'foie', nom: 'Foie', cat: 'viandes' },
            { id: 'harengs', nom: 'Harengs', cat: 'viandes' }, { id: 'huitres', nom: 'Huitres', cat: 'viandes' },
            { id: 'jambon', nom: 'Jambon', cat: 'viandes' }, { id: 'lardons', nom: 'Lardons', cat: 'viandes' },
            { id: 'morue', nom: 'Morue', cat: 'viandes' }, { id: 'moules', nom: 'Moules', cat: 'viandes' },
            { id: 'poisson', nom: 'Poisson', cat: 'viandes' }, { id: 'poulet', nom: 'Poulet', cat: 'viandes' },
            { id: 'salami', nom: 'Salami', cat: 'viandes' }, { id: 'sardines', nom: 'Sardines', cat: 'viandes' },
            { id: 'saucisses', nom: 'Saucisses', cat: 'viandes' }, { id: 'saumon', nom: 'Saumon', cat: 'viandes' },
            { id: 'thon', nom: 'Thon', cat: 'viandes' }, { id: 'tomawak', nom: 'Tomawak', cat: 'viandes' },
            { id: 'veau', nom: 'Veau', cat: 'viandes' }, { id: 'viande', nom: 'Viande', cat: 'viandes' },

            // Frais & Cr√®merie
            { id: 'affinois', nom: 'Affinois', cat: 'frais' }, { id: 'baguette', nom: 'Baguette', cat: 'frais' },
            { id: 'beurre', nom: 'Beurre', cat: 'frais' }, { id: 'chantilly', nom: 'Chantilly', cat: 'frais' },
            { id: 'creme', nom: 'Cr√®me', cat: 'frais' }, { id: 'crepes', nom: 'Cr√™pes', cat: 'frais' },
            { id: 'croissants', nom: 'Croissants', cat: 'frais' }, { id: 'flan', nom: 'Flan', cat: 'frais' },
            { id: 'fromage', nom: 'Fromage', cat: 'frais' }, { id: 'gnocchis', nom: 'Gnocchis', cat: 'frais' },
            { id: 'glace', nom: 'Glace', cat: 'frais' }, { id: 'lait', nom: 'Lait', cat: 'frais' },
            { id: 'margarine', nom: 'Margarine', cat: 'frais' }, { id: 'oeufs', nom: 'Oeufs', cat: 'frais' },
            { id: 'pain', nom: 'Pain', cat: 'frais' }, { id: 'pizza', nom: 'Pizza', cat: 'frais' },
            { id: 'quiche', nom: 'Quiche', cat: 'frais' }, { id: 'raclette', nom: 'Raclette', cat: 'frais' },
            { id: 'reblochon', nom: 'Reblochon', cat: 'frais' }, { id: 'sandwich', nom: 'Sandwich', cat: 'frais' },
            { id: 'sorbet', nom: 'Sorbet', cat: 'frais' }, { id: 'yaourt', nom: 'Yaourt', cat: 'frais' },

            // √âpicerie
            { id: 'additifs', nom: 'Additifs', cat: 'epicerie' }, { id: 'adobo', nom: 'Adobo', cat: 'epicerie' },
            { id: 'ajvar', nom: 'Ajvar', cat: 'epicerie' }, { id: 'amandes', nom: 'Amandes', cat: 'epicerie' },
            { id: 'avoine', nom: 'Avoine', cat: 'epicerie' }, { id: 'beijinho', nom: 'Beijinho', cat: 'epicerie' },
            { id: 'bicarbonate', nom: 'Bicarbonate', cat: 'epicerie' }, { id: 'bonbons', nom: 'Bonbons', cat: 'epicerie' },
            { id: 'bouillon', nom: 'Bouillon', cat: 'epicerie' }, { id: 'brioches', nom: 'Brioches', cat: 'epicerie' },
            { id: 'brownie', nom: 'Brownie', cat: 'epicerie' }, { id: 'cacahuetes', nom: 'Cacahu√®tes', cat: 'epicerie' },
            { id: 'cacao', nom: 'Cacao', cat: 'epicerie' }, { id: 'cafe', nom: 'Caf√©', cat: 'epicerie' },
            { id: 'cajou', nom: 'Cajou', cat: 'epicerie' }, { id: 'camomille', nom: 'Camomille', cat: 'epicerie' },
            { id: 'cannelle', nom: 'Cannelle', cat: 'epicerie' }, { id: 'carambars', nom: 'Carambars', cat: 'epicerie' },
            { id: 'caramel', nom: 'Caramel', cat: 'epicerie' }, { id: 'cereales', nom: 'C√©r√©ales', cat: 'epicerie' },
            { id: 'chips', nom: 'Chips', cat: 'epicerie' }, { id: 'chocolat', nom: 'Chocolat', cat: 'epicerie' },
            { id: 'clou_de_girofle', nom: 'Clou de girofle', cat: 'epicerie' }, { id: 'colorants', nom: 'Colorants', cat: 'epicerie' },
            { id: 'compotes', nom: 'Compotes', cat: 'epicerie' }, { id: 'confiture', nom: 'Confiture', cat: 'epicerie' },
            { id: 'couscous', nom: 'Couscous', cat: 'epicerie' }, { id: 'crackers', nom: 'Crackers', cat: 'epicerie' },
            { id: 'cumin', nom: 'Cumin', cat: 'epicerie' }, { id: 'curry', nom: 'Curry', cat: 'epicerie' },
            { id: 'epices', nom: '√âpices', cat: 'epicerie' }, { id: 'fajitas', nom: 'Fajitas', cat: 'epicerie' },
            { id: 'farine', nom: 'Farine', cat: 'epicerie' }, { id: 'galettes', nom: 'Galettes', cat: 'epicerie' },
            { id: 'gaufres', nom: 'Gaufres', cat: 'epicerie' }, { id: 'gelatine', nom: 'G√©latine', cat: 'epicerie' },
            { id: 'gelee', nom: 'Gel√©e', cat: 'epicerie' }, { id: 'genoise', nom: 'G√©noise', cat: 'epicerie' },
            { id: 'glucose', nom: 'Glucose', cat: 'epicerie' }, { id: 'graines', nom: 'Graines', cat: 'epicerie' },
            { id: 'guimauves', nom: 'Guimauves', cat: 'epicerie' }, { id: 'huile', nom: 'Huile', cat: 'epicerie' },
            { id: 'infusion', nom: 'Infusion', cat: 'epicerie' }, { id: 'ketchup', nom: 'Ketchup', cat: 'epicerie' },
            { id: 'lasagnes', nom: 'Lasagnes', cat: 'epicerie' }, { id: 'laurier', nom: 'Laurier', cat: 'epicerie' },
            { id: 'lentilles', nom: 'Lentilles', cat: 'epicerie' }, { id: 'levure', nom: 'Levure', cat: 'epicerie' },
            { id: 'mayonnaise', nom: 'Mayonnaise', cat: 'epicerie' }, { id: 'miel', nom: 'Miel', cat: 'epicerie' },
            { id: 'mikados', nom: 'Mikados', cat: 'epicerie' }, { id: 'moutarde', nom: 'Moutarde', cat: 'epicerie' },
            { id: 'muesli', nom: 'Muesli', cat: 'epicerie' }, { id: 'muffins', nom: 'Muffins', cat: 'epicerie' },
            { id: 'muscade', nom: 'Muscade', cat: 'epicerie' }, { id: 'noisettes', nom: 'Noisettes', cat: 'epicerie' },
            { id: 'noix', nom: 'Noix', cat: 'epicerie' }, { id: 'nouilles', nom: 'Nouilles', cat: 'epicerie' },
            { id: 'nutella', nom: 'Nutella', cat: 'epicerie' }, { id: 'olives', nom: 'Olives', cat: 'epicerie' },
            { id: 'paprika', nom: 'Paprika', cat: 'epicerie' }, { id: 'pates', nom: 'P√¢tes', cat: 'epicerie' },
            { id: 'picholine', nom: 'Picholine', cat: 'epicerie' }, { id: 'pignons', nom: 'Pignons', cat: 'epicerie' },
            { id: 'pistaches', nom: 'Pistaches', cat: 'epicerie' }, { id: 'poivre', nom: 'Poivre', cat: 'epicerie' },
            { id: 'quinoa', nom: 'Quinoa', cat: 'epicerie' }, { id: 'raviolis', nom: 'Raviolis', cat: 'epicerie' },
            { id: 'riz', nom: 'Riz', cat: 'epicerie' }, { id: 'safran', nom: 'Safran', cat: 'epicerie' },
            { id: 'sel', nom: 'Sel', cat: 'epicerie' }, { id: 'semoule', nom: 'Semoule', cat: 'epicerie' },
            { id: 'soupe', nom: 'Soupe', cat: 'epicerie' }, { id: 'spaghettis', nom: 'Spaghettis', cat: 'epicerie' },
            { id: 'sucre', nom: 'Sucre', cat: 'epicerie' }, { id: 'the', nom: 'Th√©', cat: 'epicerie' },
            { id: 'tisane', nom: 'Tisane', cat: 'epicerie' }, { id: 'tortillas', nom: 'Tortillas', cat: 'epicerie' },
            { id: 'vanille', nom: 'Vanille', cat: 'epicerie' }, { id: 'vinaigre', nom: 'Vinaigre', cat: 'epicerie' },

            // Boissons
            { id: 'affligem', nom: 'Affligem', cat: 'boissons' }, { id: 'beaujolais', nom: 'Beaujolais', cat: 'boissons' },
            { id: 'bieres', nom: 'Bi√®res', cat: 'boissons' }, { id: 'champagne', nom: 'Champagne', cat: 'boissons' },
            { id: 'cidre', nom: 'Cidre', cat: 'boissons' }, { id: 'cognac', nom: 'Cognac', cat: 'boissons' },
            { id: 'eau', nom: 'Eau', cat: 'boissons' }, { id: 'gewurztraminer', nom: 'Gewurztraminer', cat: 'boissons' },
            { id: 'isotonique', nom: 'Isotonique', cat: 'boissons' }, { id: 'limonade', nom: 'Limonade', cat: 'boissons' },
            { id: 'liqueur', nom: 'Liqueur', cat: 'boissons' }, { id: 'pinard', nom: 'Pinard', cat: 'boissons' },
            { id: 'rhum', nom: 'Rhum', cat: 'boissons' }, { id: 'schweppes', nom: 'Schweppes', cat: 'boissons' },
            { id: 'soda', nom: 'Soda', cat: 'boissons' }, { id: 'sprite', nom: 'Sprite', cat: 'boissons' },
            { id: 'vin', nom: 'Vin', cat: 'boissons' }, { id: 'vodka', nom: 'Vodka', cat: 'boissons' },
            { id: 'whisky', nom: 'Whisky', cat: 'boissons' },

            // Hygi√®ne & Beaut√©
            { id: 'aspirine', nom: 'Aspirine', cat: 'hygiene' }, { id: 'brosse', nom: 'Brosse', cat: 'hygiene' },
            { id: 'coton', nom: 'Coton', cat: 'hygiene' }, { id: 'couches', nom: 'Couches', cat: 'hygiene' },
            { id: 'dentifrice', nom: 'Dentifrice', cat: 'hygiene' }, { id: 'eucalyptus', nom: 'Eucalyptus', cat: 'hygiene' },
            { id: 'exfoliant', nom: 'Exfoliant', cat: 'hygiene' }, { id: 'gel_douche', nom: 'Gel douche', cat: 'hygiene' },
            { id: 'laque', nom: 'Laque', cat: 'hygiene' }, { id: 'lingettes', nom: 'Lingettes', cat: 'hygiene' },
            { id: 'lotion', nom: 'Lotion', cat: 'hygiene' }, { id: 'mascara', nom: 'Mascara', cat: 'hygiene' },
            { id: 'mouchoirs', nom: 'Mouchoirs', cat: 'hygiene' }, { id: 'peigne', nom: 'Peigne', cat: 'hygiene' },
            { id: 'rasoir', nom: 'Rasoir', cat: 'hygiene' }, { id: 'savon', nom: 'Savon', cat: 'hygiene' },
            { id: 'schwarzkopf', nom: 'Schwarzkopf', cat: 'hygiene' }, { id: 'shampoing', nom: 'Shampoing', cat: 'hygiene' },
            { id: 'talc', nom: 'Talc', cat: 'hygiene' }, { id: 'tampons', nom: 'Tampons', cat: 'hygiene' },
            { id: 'vaseline', nom: 'Vaseline', cat: 'hygiene' }, { id: 'vernis', nom: 'Vernis', cat: 'hygiene' },
            { id: 'vitamines', nom: 'Vitamines', cat: 'hygiene' },

            // Maison & Entretien
            { id: 'adoucissant', nom: 'Adoucissant', cat: 'entretien' }, { id: 'ajax', nom: 'Ajax', cat: 'entretien' },
            { id: 'aluminium', nom: 'Aluminium', cat: 'entretien' }, { id: 'ampoules', nom: 'Ampoules', cat: 'entretien' },
            { id: 'assouplissant', nom: 'Assouplissant', cat: 'entretien' }, { id: 'balai', nom: 'Balai', cat: 'entretien' },
            { id: 'cirage', nom: 'Cirage', cat: 'entretien' }, { id: 'colle', nom: 'Colle', cat: 'entretien' },
            { id: 'eponges', nom: '√âponges', cat: 'entretien' }, { id: 'javel', nom: 'Javel', cat: 'entretien' },
            { id: 'lessive', nom: 'Lessive', cat: 'entretien' }, { id: 'piles', nom: 'Piles', cat: 'entretien' },
            { id: 'sacs_poubelle', nom: 'Sacs poubelle', cat: 'entretien' }, { id: 'spray', nom: 'Spray', cat: 'entretien' },

            // Divers
            { id: 'agenda', nom: 'Agenda', cat: 'divers' }, { id: 'agrafeuse', nom: 'Agrafeuse', cat: 'divers' },
            { id: 'aiguille', nom: 'Aiguille', cat: 'divers' }, { id: 'aimants', nom: 'Aimants', cat: 'divers' },
            { id: 'allumettes', nom: 'Allumettes', cat: 'divers' }, { id: 'anorak', nom: 'Anorak', cat: 'divers' },
            { id: 'applique', nom: 'Applique', cat: 'divers' }, { id: 'ardoise', nom: 'Ardoise', cat: 'divers' },
            { id: 'aspirateur', nom: 'Aspirateur', cat: 'divers' }, { id: 'assiettes', nom: 'Assiettes', cat: 'divers' },
            { id: 'azote', nom: 'Azote', cat: 'divers' }, { id: 'balance', nom: 'Balance', cat: 'divers' },
            { id: 'ballon', nom: 'Ballon', cat: 'divers' }, { id: 'banjo', nom: 'Banjo', cat: 'divers' },
            { id: 'barbie', nom: 'Barbie', cat: 'divers' }, { id: 'besace', nom: 'Besace', cat: 'divers' },
            { id: 'bidon', nom: 'Bidon', cat: 'divers' }, { id: 'bijou', nom: 'Bijou', cat: 'divers' },
            { id: 'blackjack', nom: 'Blackjack', cat: 'divers' }, { id: 'bocaux', nom: 'Bocaux', cat: 'divers' },
            { id: 'bouee', nom: 'Bou√©e', cat: 'divers' }, { id: 'bougeoir', nom: 'Bougeoir', cat: 'divers' },
            { id: 'bougies', nom: 'Bougies', cat: 'divers' }, { id: 'briquet', nom: 'Briquet', cat: 'divers' },
            { id: 'cadenas', nom: 'Cadenas', cat: 'divers' }, { id: 'cadre', nom: 'Cadre', cat: 'divers' },
            { id: 'cahier', nom: 'Cahier', cat: 'divers' }, { id: 'calculette', nom: 'Calculette', cat: 'divers' },
            { id: 'camera', nom: 'Camera', cat: 'divers' }, { id: 'carnet', nom: 'Carnet', cat: 'divers' },
            { id: 'cartes', nom: 'Cartes', cat: 'divers' }, { id: 'cartouches', nom: 'Cartouches', cat: 'divers' },
            { id: 'casquette', nom: 'Casquette', cat: 'divers' }, { id: 'casserole', nom: 'Casserole', cat: 'divers' },
            { id: 'ceinture', nom: 'Ceinture', cat: 'divers' }, { id: 'chalumeau', nom: 'Chalumeau', cat: 'divers' },
            { id: 'chapeau', nom: 'Chapeau', cat: 'divers' }, { id: 'charbon', nom: 'Charbon', cat: 'divers' },
            { id: 'chargeur', nom: 'Chargeur', cat: 'divers' }, { id: 'chaussettes', nom: 'Chaussettes', cat: 'divers' },
            { id: 'chronometre', nom: 'Chronom√®tre', cat: 'divers' }, { id: 'cintres', nom: 'Cintres', cat: 'divers' },
            { id: 'cisaille', nom: 'Cisaille', cat: 'divers' }, { id: 'ciseaux', nom: 'Ciseaux', cat: 'divers' },
            { id: 'clous', nom: 'Clous', cat: 'divers' }, { id: 'confettis', nom: 'Confettis', cat: 'divers' },
            { id: 'coquetier', nom: 'Coquetier', cat: 'divers' }, { id: 'corde', nom: 'Corde', cat: 'divers' },
            { id: 'couette', nom: 'Couette', cat: 'divers' }, { id: 'coussin', nom: 'Coussin', cat: 'divers' },
            { id: 'couteau', nom: 'Couteau', cat: 'divers' }, { id: 'couverts', nom: 'Couverts', cat: 'divers' },
            { id: 'crampons', nom: 'Crampons', cat: 'divers' }, { id: 'crayons', nom: 'Crayons', cat: 'divers' },
            { id: 'croquettes', nom: 'Croquettes', cat: 'divers' }, { id: 'cuilleres', nom: 'Cuill√®res', cat: 'divers' },
            { id: 'culottes', nom: 'Culottes', cat: 'divers' }, { id: 'deguisement', nom: 'D√©guisement', cat: 'divers' },
            { id: 'dictionnaire', nom: 'Dictionnaire', cat: 'divers' }, { id: 'drapeau', nom: 'Drapeau', cat: 'divers' },
            { id: 'duvet', nom: 'Duvet', cat: 'divers' }, { id: 'echelle', nom: '√âchelle', cat: 'divers' },
            { id: 'eclairage', nom: '√âclairage', cat: 'divers' }, { id: 'ecran', nom: '√âcran', cat: 'divers' },
            { id: 'ecrous', nom: '√âcrous', cat: 'divers' }, { id: 'elastiques', nom: '√âlastiques', cat: 'divers' },
            { id: 'encens', nom: 'Encens', cat: 'divers' }, { id: 'encre', nom: 'Encre', cat: 'divers' },
            { id: 'enveloppes', nom: 'Enveloppes', cat: 'divers' }, { id: 'equerre', nom: '√âquerre', cat: 'divers' },
            { id: 'fenetre', nom: 'Fen√™tre', cat: 'divers' }, { id: 'feutres', nom: 'Feutres', cat: 'divers' },
            { id: 'fixations', nom: 'Fixations', cat: 'divers' }, { id: 'fleurs', nom: 'Fleurs', cat: 'divers' },
            { id: 'flute', nom: 'Fl√ªte', cat: 'divers' }, { id: 'fourchettes', nom: 'Fourchettes', cat: 'divers' },
            { id: 'gants', nom: 'Gants', cat: 'divers' }, { id: 'gobelets', nom: 'Gobelets', cat: 'divers' },
            { id: 'gomme', nom: 'Gomme', cat: 'divers' }, { id: 'guirlande', nom: 'Guirlande', cat: 'divers' },
            { id: 'horloge', nom: 'Horloge', cat: 'divers' }, { id: 'icewatch', nom: 'Icewatch', cat: 'divers' },
            { id: 'journal', nom: 'Journal', cat: 'divers' }, { id: 'lame', nom: 'Lame', cat: 'divers' },
            { id: 'livre', nom: 'Livre', cat: 'divers' }, { id: 'louche', nom: 'Louche', cat: 'divers' },
            { id: 'magazines', nom: 'Magazines', cat: 'divers' }, { id: 'magnets', nom: 'Magnets', cat: 'divers' },
            { id: 'maillot', nom: 'Maillot', cat: 'divers' }, { id: 'manette', nom: 'Manette', cat: 'divers' },
            { id: 'maniques', nom: 'Maniques', cat: 'divers' }, { id: 'marmite', nom: 'Marmite', cat: 'divers' },
            { id: 'marteau', nom: 'Marteau', cat: 'divers' }, { id: 'martinet', nom: 'Martinet', cat: 'divers' },
            { id: 'metre', nom: 'M√®tre', cat: 'divers' }, { id: 'nappe', nom: 'Nappe', cat: 'divers' },
            { id: 'oreiller', nom: 'Oreiller', cat: 'divers' }, { id: 'pailles', nom: 'Pailles', cat: 'divers' },
            { id: 'panier', nom: 'Panier', cat: 'divers' }, { id: 'pantalon', nom: 'Pantalon', cat: 'divers' },
            { id: 'pantoufles', nom: 'Pantoufles', cat: 'divers' }, { id: 'passoire', nom: 'Passoire', cat: 'divers' },
            { id: 'patchwork', nom: 'Patchwork', cat: 'divers' }, { id: 'peinture', nom: 'Peinture', cat: 'divers' },
            { id: 'peluche', nom: 'Peluche', cat: 'divers' }, { id: 'perruque', nom: 'Perruque', cat: 'divers' },
            { id: 'pinceaux', nom: 'Pinceaux', cat: 'divers' }, { id: 'projecteur', nom: 'Projecteur', cat: 'divers' },
            { id: 'puzzle', nom: 'Puzzle', cat: 'divers' }, { id: 'radiateur', nom: 'Radiateur', cat: 'divers' },
            { id: 'radio', nom: 'Radio', cat: 'divers' }, { id: 'rateau', nom: 'R√¢teau', cat: 'divers' },
            { id: 'scanner', nom: 'Scanner', cat: 'divers' }, { id: 'scie', nom: 'Scie', cat: 'divers' },
            { id: 'scotch', nom: 'Scotch', cat: 'divers' }, { id: 'seau', nom: 'Seau', cat: 'divers' },
            { id: 'semelle', nom: 'Semelle', cat: 'divers' }, { id: 'serviettes', nom: 'Serviettes', cat: 'divers' },
            { id: 'short', nom: 'Short', cat: 'divers' }, { id: 'skate', nom: 'Skate', cat: 'divers' },
            { id: 'snowboard', nom: 'Snowboard', cat: 'divers' }, { id: 'souris', nom: 'Souris', cat: 'divers' },
            { id: 'stylos', nom: 'Stylos', cat: 'divers' }, { id: 'swatch', nom: 'Swatch', cat: 'divers' },
            { id: 'tapis', nom: 'Tapis', cat: 'divers' }, { id: 'tasse', nom: 'Tasse', cat: 'divers' },
            { id: 'tissu', nom: 'Tissu', cat: 'divers' }, { id: 'tongs', nom: 'Tongs', cat: 'divers' },
            { id: 'torchon', nom: 'Torchon', cat: 'divers' }, { id: 'trombonnes', nom: 'Trombonnes', cat: 'divers' },
            { id: 'trousse', nom: 'Trousse', cat: 'divers' }, { id: 'tshirt', nom: 'T-shirt', cat: 'divers' },
            { id: 'tuyau', nom: 'Tuyau', cat: 'divers' }, { id: 'twister', nom: 'Twister', cat: 'divers' },
            { id: 'ukulele', nom: 'Ukul√©l√©', cat: 'divers' }, { id: 'uniforme', nom: 'Uniforme', cat: 'divers' },
            { id: 'ustensile', nom: 'Ustensile', cat: 'divers' }, { id: 'vaisselle', nom: 'Vaisselle', cat: 'divers' },
            { id: 'valise', nom: 'Valise', cat: 'divers' }, { id: 'vaporisateur', nom: 'Vaporisateur', cat: 'divers' },
            { id: 'vase', nom: 'Vase', cat: 'divers' }, { id: 'ventilateur', nom: 'Ventilateur', cat: 'divers' },
            { id: 'verres', nom: 'Verres', cat: 'divers' }, { id: 'veste', nom: 'Veste', cat: 'divers' },
            { id: 'walkman', nom: 'Walkman', cat: 'divers' }, { id: 'webcam', nom: 'Webcam', cat: 'divers' },
            { id: 'xbox', nom: 'Xbox', cat: 'divers' }, { id: 'yoyo', nom: 'Yoyo', cat: 'divers' },
            { id: 'zinc', nom: 'Zinc', cat: 'divers' }
        ];

        // --- 2. √âtat (State) ---
        let appState = {
            items: [],
            hideBought: false,
            theme: 'dark',
            customItems: []
        };

        // --- 3. Initialisation & LocalStorage ---
        function init() {
            loadState();
            renderCategories();
            renderList();
            applyTheme();
            setupEvents();
        }

        function loadState() {
            const saved = localStorage.getItem('shopping_app_state_v3');
            let savedItemsState = {};
            let savedCustomItems = [];
            let savedSettings = {};

            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    savedItemsState = parsed.itemsState || {};
                    savedCustomItems = parsed.customItems || [];
                    savedSettings = parsed.settings || {};
                } catch (e) { console.error("Erreur loadState", e); }
            }

            const allBaseItems = [...baseDefaultItems, ...savedCustomItems];

            appState.items = allBaseItems.map(item => {
                const state = savedItemsState[item.id] || {};
                return {
                    ...item,
                    selected: state.selected || false,
                    bought: state.bought || false,
                    qtyValue: state.qtyValue || 1,
                    unit: state.unit || 'pcs'
                };
            });

            appState.customItems = savedCustomItems;
            appState.hideBought = savedSettings.hideBought || false;
            appState.theme = savedSettings.theme || 'dark';
        }

        function saveState() {
            const itemsState = {};
            appState.items.forEach(item => {
                if (item.selected || item.bought || item.qtyValue > 1 || item.unit !== 'pcs') {
                    itemsState[item.id] = {
                        selected: item.selected,
                        bought: item.bought,
                        qtyValue: item.qtyValue,
                        unit: item.unit
                    };
                }
            });

            const data = {
                itemsState: itemsState,
                customItems: appState.customItems,
                settings: { hideBought: appState.hideBought, theme: appState.theme }
            };
            localStorage.setItem('shopping_app_state_v3', JSON.stringify(data));
            renderList();
        }

        // --- 4. Rendu (View) ---
        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'category-card';
                div.innerHTML = `<span class="cat-icon">${cat.icon}</span><span class="cat-name">${cat.nom}</span>`;
                div.onclick = (e) => { e.stopPropagation(); showCategoryItems(cat.id); };
                grid.appendChild(div);
            });
        }

        function renderList() {
            const listToBuy = document.getElementById('list-to-buy');
            const listBought = document.getElementById('list-bought');
            const toggleBtn = document.getElementById('toggle-bought-btn');

            listToBuy.innerHTML = '';
            listBought.innerHTML = '';

            const itemsToBuy = appState.items.filter(i => i.selected && !i.bought);
            const itemsBought = appState.items.filter(i => i.selected && i.bought);

            document.getElementById('count-to-buy').textContent = `(${itemsToBuy.length})`;
            document.getElementById('count-bought').textContent = `(${itemsBought.length})`;

            // Tri par Rayon
            if (itemsToBuy.length === 0) {
                listToBuy.innerHTML = '<div class="empty-state">Ta liste est vide. Ajoute des articles !</div>';
            } else {
                categories.forEach(cat => {
                    const catItems = itemsToBuy.filter(i => i.cat === cat.id);
                    if (cat.id === 'divers') {
                        const knownCats = categories.map(c => c.id);
                        const orphans = itemsToBuy.filter(i => !knownCats.includes(i.cat));
                        catItems.push(...orphans);
                    }

                    if (catItems.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'list-group-header';
                        header.textContent = `${cat.icon} ${cat.nom}`;
                        listToBuy.appendChild(header);
                        catItems.forEach(item => listToBuy.appendChild(createItemElement(item)));
                    }
                });
            }

            if (appState.hideBought) {
                listBought.classList.add('hidden-visually');
                toggleBtn.textContent = 'Afficher';
            } else {
                listBought.classList.remove('hidden-visually');
                toggleBtn.textContent = 'Masquer';
                itemsBought.forEach(item => listBought.appendChild(createItemElement(item)));
            }
        }

        function createItemElement(item) {
            const div = document.createElement('div');
            div.className = `shopping-item ${item.bought ? 'bought' : ''}`;

            div.onclick = (e) => {
                if (!e.target.closest('.qty-control')) toggleItemStatus(item.id);
            };

            const unitDisplay = item.unit === 'pcs' ? '' : item.unit;
            const hasDetails = item.qtyValue > 1 || item.unit !== 'pcs';

            div.innerHTML = `
                <div class="checkbox"></div>
                <div class="item-info">
                    <div class="item-name">${item.nom}</div>
                    ${hasDetails ? `<div class="item-details"><span class="qty-badge">${item.qtyValue} ${unitDisplay}</span></div>` : ''}
                </div>
                
                <div class="qty-control" onclick="event.stopPropagation()">
                    <button class="qty-btn" onclick="updateQty('${item.id}', -1)">‚àí</button>
                    <input type="number" class="qty-input" value="${item.qtyValue}" min="0.1" step="any" 
                           onchange="setQtyManual('${item.id}', this.value)"
                           onclick="this.select()">
                    <button class="qty-btn" onclick="updateQty('${item.id}', 1)">+</button>
                    <button class="unit-btn" onclick="cycleUnit('${item.id}')">${item.unit}</button>
                </div>
            `;
            return div;
        }

        // --- 5. Actions ---
        function updateQty(id, delta) {
            const item = appState.items.find(i => i.id === id);
            if (item) {
                let newVal = (parseFloat(item.qtyValue) || 0) + delta;
                if (newVal <= 0) newVal = 1;
                item.qtyValue = newVal;
                saveState();
            }
        }

        function setQtyManual(id, valueStr) {
            const item = appState.items.find(i => i.id === id);
            if (item) {
                let newVal = parseFloat(valueStr.replace(',', '.'));
                if (isNaN(newVal) || newVal <= 0) newVal = 1;
                item.qtyValue = newVal;
                saveState();
            }
        }

        function cycleUnit(id) {
            const item = appState.items.find(i => i.id === id);
            const units = ['pcs', 'kg', 'g', 'L', 'pqt'];
            if (item) {
                const idx = units.indexOf(item.unit);
                item.unit = units[(idx + 1) % units.length];
                saveState();
            }
        }

        function toggleItemStatus(id) {
            const item = appState.items.find(i => i.id === id);
            if (item) {
                item.bought = !item.bought;
                saveState();
            }
        }

        // --- 6. Events & Recherche ---
        function setupEvents() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const val = e.target.value.trim();
                    if (val) addCustomItem(val);
                }
            });

            document.getElementById('toggle-bought-btn').addEventListener('click', () => {
                appState.hideBought = !appState.hideBought;
                saveState();
            });

            document.getElementById('reset-btn').addEventListener('click', () => {
                if (confirm("Tout vider ?")) {
                    appState.items.forEach(i => { i.selected = false; i.bought = false; i.qtyValue = 1; i.unit = 'pcs'; });
                    renderList();
                    saveState();
                }
            });

            document.getElementById('theme-toggle').addEventListener('click', () => {
                appState.theme = appState.theme === 'light' ? 'dark' : 'light';
                applyTheme();
                saveState();
            });

            document.getElementById('share-btn').addEventListener('click', shareList);

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) document.getElementById('autocomplete-list').classList.add('hidden');
            });
        }

        function handleSearch(e) {
            const val = e.target.value.toLowerCase();
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';

            if (!val) { list.classList.add('hidden'); return; }

            const matches = appState.items.filter(item => item.nom.toLowerCase().includes(val));
            list.classList.remove('hidden');

            if (matches.length > 0) {
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    const status = item.selected ? (item.bought ? '‚úÖ' : 'üõí') : '‚ûï';
                    div.innerHTML = `<span>${status} <strong>${item.nom}</strong></span>`;
                    div.onclick = () => {
                        selectItem(item.id);
                        document.getElementById('search-input').value = '';
                        list.classList.add('hidden');
                    };
                    list.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `‚ûï Cr√©er "<strong>${val}</strong>"`;
                div.onclick = () => addCustomItem(val);
                list.appendChild(div);
            }
        }

        function selectItem(id) {
            const item = appState.items.find(i => i.id === id);
            if (item) {
                item.selected = true;
                item.bought = false;
                saveState();
            }
        }

        function addCustomItem(name) {
            if (!name) return;
            const formattedName = name.charAt(0).toUpperCase() + name.slice(1);
            const newItem = {
                id: 'custom_' + Date.now(),
                nom: formattedName,
                cat: 'divers',
                selected: true,
                bought: false,
                qtyValue: 1,
                unit: 'pcs'
            };
            appState.customItems.push(newItem);
            appState.items.push(newItem);
            saveState();
            document.getElementById('search-input').value = '';
            document.getElementById('autocomplete-list').classList.add('hidden');
        }

        function showCategoryItems(catId) {
            const catItems = appState.items.filter(i => i.cat === catId);
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';
            list.classList.remove('hidden');

            const title = document.createElement('div');
            title.style.padding = '8px 12px';
            title.style.fontWeight = 'bold';
            title.style.backgroundColor = 'var(--bg-color)';
            title.textContent = categories.find(c => c.id === catId).nom;
            list.appendChild(title);

            catItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                const status = item.selected ? (item.bought ? '‚úÖ' : 'üõí') : '‚ûï';
                div.innerHTML = `<span>${status} ${item.nom}</span>`;
                div.onclick = () => {
                    if (!item.selected) selectItem(item.id);
                    div.innerHTML = `<span>üõí ${item.nom}</span>`;
                };
                list.appendChild(div);
            });
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', appState.theme);
            document.getElementById('theme-toggle').textContent = appState.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        async function shareList() {
            const itemsToBuy = appState.items.filter(i => i.selected && !i.bought);

            if (itemsToBuy.length === 0) {
                alert("Rien √† partager, ta liste est vide !");
                return;
            }

            // G√©n√©ration du lien de partage
            // Format: ?shared=id1:qty1,id2:qty2&custom=Name1:qty1,Name2:qty2
            const standardItems = itemsToBuy.filter(i => i.id && !i.id.startsWith('custom_'));
            const customItems = itemsToBuy.filter(i => i.id && i.id.startsWith('custom_'));

            let urlParams = new URLSearchParams();

            if (standardItems.length > 0) {
                const sharedStr = standardItems.map(i => `${i.id}:${i.qtyValue}`).join(',');
                urlParams.set('shared', sharedStr);
            }

            if (customItems.length > 0) {
                const customStr = customItems.map(i => `${i.nom}:${i.qtyValue}`).join(',');
                urlParams.set('custom', customStr);
            }

            const shareUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;

            // Construction du message texte
            let text = `üõí *Ma Liste de Courses*\n\n`;
            text += `üîó *Lien pour importer la liste :*\n${shareUrl}\n\n`;
            text += `üìù *D√©tails :*\n`;

            categories.forEach(cat => {
                const catItems = itemsToBuy.filter(i => i.cat === cat.id);
                // Pour les orphelins (cat√©gorie 'divers' ou inconnue)
                if (cat.id === 'divers') {
                    const knownCats = categories.map(c => c.id);
                    const orphans = itemsToBuy.filter(i => !knownCats.includes(i.cat));
                    const trueDivers = itemsToBuy.filter(i => i.cat === 'divers');
                    const combined = [...new Set([...trueDivers, ...orphans])];

                    if (combined.length > 0) {
                        text += `*${cat.nom}* :\n`;
                        combined.forEach(item => {
                            const unitDisplay = item.unit === 'pcs' ? '' : item.unit;
                            const qty = (item.qtyValue > 1 || item.unit !== 'pcs') ? ` (${item.qtyValue} ${unitDisplay})` : '';
                            text += `- ${item.nom}${qty}\n`;
                        });
                        text += "\n";
                    }
                } else if (catItems.length > 0) {
                    text += `*${cat.nom}* :\n`;
                    catItems.forEach(item => {
                        const unitDisplay = item.unit === 'pcs' ? '' : item.unit;
                        const qty = (item.qtyValue > 1 || item.unit !== 'pcs') ? ` (${item.qtyValue} ${unitDisplay})` : '';
                        text += `- ${item.nom}${qty}\n`;
                    });
                    text += "\n";
                }
            });

            const shareData = {
                title: 'Ma Liste de Courses',
                text: text,
                url: shareUrl
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    await navigator.clipboard.writeText(text);
                    alert("Lien et liste copi√©s dans le presse-papier !");
                }
            } catch (err) {
                console.error('Erreur de partage :', err);
                // Fallback si le partage (avec URL) √©choue sur certains navigateurs
                try {
                    delete shareData.url;
                    await navigator.share(shareData);
                } catch (e2) {
                    await navigator.clipboard.writeText(text);
                    alert("Lien et liste copi√©s dans le presse-papier !");
                }
            }
        }

        function handleSharedUrl() {
            const params = new URLSearchParams(window.location.search);
            const sharedParam = params.get('shared');
            const customParam = params.get('custom');
            let addedCount = 0;

            if (sharedParam) {
                // Format: id:qty,id:qty
                const shares = sharedParam.split(',');
                shares.forEach(share => {
                    const [id, qtyStr] = share.split(':');
                    const qty = parseFloat(qtyStr) || 1;

                    // Trouver l'item
                    const item = appState.items.find(i => i.id === id);
                    if (item) {
                        item.selected = true;
                        item.bought = false;
                        item.qtyValue = qty;
                        addedCount++;
                    }
                });
            }

            if (customParam) {
                // Format: Name:qty,Name:qty
                const customs = customParam.split(',');
                customs.forEach(c => {
                    const parts = c.split(':');
                    // Le nom peut contenir des ':', donc on prend tout jusqu'au dernier segment si on a ajout√© qty
                    // Mais restons simple: Name:qty. Si Name a des :, √ßa casse. Acceptons le risque ou split last.
                    // Pour simplifier : lastIndexOf pour split
                    const lastColonIndex = c.lastIndexOf(':');
                    let name, qty = 1;

                    if (lastColonIndex !== -1) {
                        const possibleQty = parseFloat(c.substring(lastColonIndex + 1));
                        if (!isNaN(possibleQty)) {
                            name = c.substring(0, lastColonIndex);
                            qty = possibleQty;
                        } else {
                            name = c; // Pas de quantit√© d√©tect√©e
                        }
                    } else {
                        name = c;
                    }

                    if (name) {
                        // On r√©utilise la logique d'ajout custom mais sans l'ID al√©atoire si possible ou on laisse addCustomItem g√©rer
                        // addCustomItem g√©n√®re un ID unique et push.
                        // On va adapter addCustomItem pour accepter qty ou le faire manuellement ici

                        // Check if already exists (custom with same name)
                        const existing = appState.items.find(i => i.nom.toLowerCase() === name.toLowerCase() && i.id.startsWith('custom_'));
                        if (existing) {
                            existing.selected = true;
                            existing.bought = false;
                            existing.qtyValue = qty;
                        } else {
                            const formattedName = name.charAt(0).toUpperCase() + name.slice(1);
                            const newItem = {
                                id: 'custom_' + Date.now() + Math.random().toString(36).substr(2, 5), // Unique ID
                                nom: formattedName,
                                cat: 'divers',
                                selected: true,
                                bought: false,
                                qtyValue: qty,
                                unit: 'pcs'
                            };
                            appState.customItems.push(newItem);
                            appState.items.push(newItem);
                        }
                        addedCount++;
                    }
                });
            }

            if (addedCount > 0) {
                saveState();
                // Nettoyer l'URL
                const newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);

                alert(`${addedCount} articles ont √©t√© ajout√©s √† votre liste depuis le lien partag√© !`);
            }
        }

        function init() {
            loadState();
            handleSharedUrl(); // V√©rifier si on vient d'un lien de partage
            renderCategories();
            renderList();
            applyTheme();
            setupEvents();
        }

        // Lancer l'application
        init();
    </script>
</body>

</html>